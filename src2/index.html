<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights</title>
    <style>
        #contentIframe {
            border: none;
            width: 100vw;
            height: 100vh;
        }
    </style>
    <script src="https://rc-con.dataloop.ai/dlAppLib.js"></script>
    <script>
        let dataset_id = null;
        let project_id = null;
        console.log('1 before onload')

        window.onload = function () {
            console.log('1 whaaaaaaa')

            window.dl.init()
            console.log('1 whaaaaaaa')

            async function init() {
                await window.dl.on('ready', async () => {
                    console.log('ready')
                    await main()
                    const settings = await this.dl.settings.get();
                    changeIframeTheme(settings.theme)
                    await window.dl.on('theme', (data) => {
                        changeIframeTheme(data);
                    })
                    
                })
            }
            init()
        }
        async function changeIframeTheme(theme) {
            fetch(`/insights/settings/${dataset_id}`, {
                method: 'POST', // Specify the method
                headers: {
                    'Content-Type': 'application/json', // Specify the content type
                },
                body: JSON.stringify({theme:theme}), // Convert the JavaScript object to a JSON string
            })
                .then(response => response.json()) // Parse the JSON response
                .then(data => {
                    console.log('Success:', data); // Handle success
                })
                .catch((error) => {
                    console.error('Error:', error); // Handle errors
                });
            document.getElementById('contentIframe').src = document.getElementById('contentIframe').src;
        }
        async function main() {
            console.log('1 whaaaaaaa')
            project_id = (await window.dl.projects.get()).id;
            console.log('1 whaaaaaaa', project_id)

            dataset_id = (await window.dl.datasets.get()).id;
            console.log('2 whaaaaaaa', dataset_id)
            document.getElementById("contentIframe").src = `/insights/build/${dataset_id}`
        }

    </script>
</head>

<body>
    <iframe id="contentIframe" src="/insights/main"></iframe>
</body>

</html>